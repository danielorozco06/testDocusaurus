<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://danielorozco06.github.io/blog</id>
    <title>Jest Blog</title>
    <updated>2016-10-03T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://danielorozco06.github.io/blog"/>
    <subtitle>Jest Blog</subtitle>
    <icon>https://danielorozco06.github.io/img/favicon/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Jest 16.0: Turbocharged CLI & Community Update]]></title>
        <id>https://danielorozco06.github.io/blog/2016/10/03/jest-16</id>
        <link href="https://danielorozco06.github.io/blog/2016/10/03/jest-16"/>
        <updated>2016-10-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[It's been one month since the last major release and we've made significant improvements to Jest since. In this major release we are updating the snapshot format we are using which will likely require snapshots to be updated when upgrading Jest. We don't make these changes lightly and don't expect this to happen often but we think it is necessary to improve the format from time to time.]]></summary>
        <content type="html"><![CDATA[<p>It's been one month since the last major release and we've made significant improvements to Jest since. In this major release we are updating the snapshot format we are using which will likely require snapshots to be updated when upgrading Jest. We don't make these changes lightly and don't expect this to happen often but we think it is necessary to improve the format from time to time.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="upgraded-cli">Upgraded CLI<a href="https://danielorozco06.github.io/blog/2016/10/03/jest-16#upgraded-cli" class="hash-link" aria-label="Direct link to Upgraded CLI" title="Direct link to Upgraded CLI">​</a></h2>
<p><img decoding="async" loading="lazy" alt="reporter" src="https://danielorozco06.github.io/assets/images/16-reporter-578f46980efc5766386bed963d75e333.gif" width="858" height="575" class="img_ev3q"></p>
<p>Jest 16 features a new reporter interface that shows running tests as well as a live summary and a progress bar based on the estimated test runtime from previous test runs. We also improved the CLI output to work better with different color schemes. If there were test failures in a previous run, Jest will now always run those tests first to give useful signal to users as quickly as possible.</p>
<p>We also added a lot of new features which you may find useful:</p>
<ul>
<li>New CLI flags were added: A <code>--testNamePattern=pattern</code> or <code>-t &lt;pattern&gt;</code> option was added to filter tests from the command line much like <code>it.only</code> or <code>fit</code> does in tests.</li>
<li>Previously failed tests now always run first.</li>
<li><code>jest &lt;pattern&gt;</code> is now case-insensitive to make it easier to filter test files.</li>
<li>A test run in watch mode can now be interrupted. During a test run, simply press any of the keys used for input during watch mode (<code>a</code>, <code>o</code>, <code>p</code>, <code>q</code> or <code>enter</code>) to abort a test run and start a new one.</li>
<li>The <code>--bail</code> flag now also works in watch mode. Together with running failed tests first, Jest's watch mode will now feel turbocharged!</li>
<li>Jest now automatically considers files and tests with the <code>jsx</code> extension.</li>
<li>Jest warns about duplicate manual mock files and we improved automatically created mocks for ES modules compiled with babel.</li>
<li>A <code>jest.clearAllMocks</code> function was added to clear all mocks in between tests.</li>
<li>We improved module resolution when <code>moduleNameMapper</code> is used.</li>
<li>Finally, a <code>--findRelatedTests &lt;fileA&gt; &lt;fileB&gt;</code> cli option was added to run tests related to the specified files. This is especially helpful as a pre-commit hook if you'd like to run tests only on a specified set of files that have tests associated with them.</li>
</ul>
<p>This is what Jest looks like when a test run is interrupted in watch mode: <img decoding="async" loading="lazy" alt="watch" src="https://danielorozco06.github.io/assets/images/16-watch-db5e0e957c19a9b2499e018c81762993.gif" width="858" height="575" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="snapshot-updates">Snapshot Updates<a href="https://danielorozco06.github.io/blog/2016/10/03/jest-16#snapshot-updates" class="hash-link" aria-label="Direct link to Snapshot Updates" title="Direct link to Snapshot Updates">​</a></h2>
<p>Jest's snapshot implementation was completely rewritten. The new version of the <code>jest-snapshot</code> package is now structured in a way that allows for easier integration into other test runners and enables more cool integrations like with <a href="https://voice.kadira.io/snapshot-testing-in-react-storybook-43b3b71cec4f#.qh4lzcadb" target="_blank" rel="noopener noreferrer">React Storybook</a>. Jest doesn't mark snapshots as obsolete in a file with skipped or failing tests. We also made a number of changes to the snapshot format:</p>
<ul>
<li>Objects and Arrays are now printed with a trailing comma to minimize future changes to snapshots.</li>
<li>We removed function names from snapshots. They were causing issues with different versions of Node, with code coverage instrumentation and we generally felt like it wasn't useful signal to show to the user that the name of a function has changed.</li>
<li>Snapshots are now sorted using natural sort order within a file.</li>
</ul>
<p>When upgrading to Jest 16, the diff might look similar to this one: <img decoding="async" loading="lazy" alt="snapshots" src="https://danielorozco06.github.io/assets/images/16-snapshots-3d7a3fd47cdb15728ac038948a21d2b7.png" width="1924" height="1360" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="test-library-updates">Test Library Updates<a href="https://danielorozco06.github.io/blog/2016/10/03/jest-16#test-library-updates" class="hash-link" aria-label="Direct link to Test Library Updates" title="Direct link to Test Library Updates">​</a></h2>
<p>We finished the migration of Jasmine assertions to the new Jest matchers. We added three new matchers: <code>toBeInstanceOf</code>, <code>toContainEqual</code> and <code>toThrowErrorMatchingSnapshot</code> . We have more readable failure messages for the spy/mock matchers <code>toHaveBeenLastCalledWith</code>, <code>toHaveBeenCalledWith</code>, <code>lastCalledWith</code> and <code>toBeCalledWith</code>. Now that we have rewritten all assertions and separated them into their own package, we'll be working on making them standalone so they can be integrated into any test framework if you'd like to use them outside of Jest.</p>
<p>We also added a bunch of aliases that were requested by the community. To make Jest focus on a single test you can now use either <code>it.only</code> or <code>test.only</code> or keep using <code>fit</code>; For skipping a test, <code>it.skip</code> or <code>test.skip</code> are now available alongside of <code>xit</code>; finally to define a test as concurrent you can use <code>test.concurrent</code> which is useful in case your test accesses network resources or databases.</p>
<p>Finally, if you'd like to overwrite the <code>expect</code> global with a different assertion library like <a href="http://chaijs.com/" target="_blank" rel="noopener noreferrer">chai</a>, this can now be done using the <code>setupTestFrameworkScriptFile</code> configuration option.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="community-update">Community Update<a href="https://danielorozco06.github.io/blog/2016/10/03/jest-16#community-update" class="hash-link" aria-label="Direct link to Community Update" title="Direct link to Community Update">​</a></h2>
<p>Over the last month lots of articles were written about Jest's snapshot testing feature, how to migrate to Jest and how to get started writing tests. I also did a few live videos to explain how Jest and snapshot testing works:</p>
<ul>
<li><a href="https://www.facebook.com/react/videos/1035427199869020/" target="_blank" rel="noopener noreferrer">FB Live Video about Snapshot Testing</a>.</li>
<li><a href="https://www.youtube.com/watch?v=i31VtyJSM-I&amp;feature=youtu.be" target="_blank" rel="noopener noreferrer">JavaScript &amp; React Testing with Kent C. Dodds</a>.</li>
</ul>
<p>A number of people wrote articles about snapshot testing. The most opinionated article that resonated with the Jest team was “<a href="http://benmccormick.org/2016/09/19/testing-with-jest-snapshots-first-impressions/" target="_blank" rel="noopener noreferrer">Testing with Jest Snapshots: First Impressions</a>”. Ben makes three great points in his blog post:</p>
<ol>
<li>Snapshot tests are a complement for conventional tests not a replacement.</li>
<li>Snapshot tests are more useful with a healthy code review process.</li>
<li>Snapshot tests work well with auto-mocking.</li>
</ol>
<p>We highly recommend reading the entire blog post. Ben did a fantastic job explaining the reasons why we built snapshot testing. It's important to point out that we didn't introduce snapshot testing to replace all other forms of testing but rather as a way to enable engineers to write tests for code that they otherwise wouldn't write tests for. It works well for things like React components, CLI output, error messages and many others but it doesn't solve all problems. Jest's goal is to provide many different ways to write effective tests without sacrificing performance or the project's maintainability.</p>
<p>Other highlights about snapshot testing:</p>
<ul>
<li>A React Native testing series: <a href="https://blog.callstack.io/unit-testing-react-native-with-the-new-jest-i-snapshots-come-into-play-68ba19b1b9fe" target="_blank" rel="noopener noreferrer">Part 1: Jest – Snapshot come into play</a> and <a href="https://blog.callstack.io/unit-testing-react-native-with-the-new-jest-ii-redux-snapshots-for-your-actions-and-reducers-8559f6f8050b#.putt9eipm" target="_blank" rel="noopener noreferrer">Part 2: Jest – Redux Snapshots for your Actions and Reducers</a>.</li>
<li><a href="https://blog.grommet.io/post/2016/09/01/how-we-landed-on-jest-snapshot-testing-for-javascript" target="_blank" rel="noopener noreferrer">How we landed on Jest snapshot testing for JavaScript</a>.</li>
<li><a href="http://guigrpa.github.io/2016/09/27/picture-this-snapshot-testing/" target="_blank" rel="noopener noreferrer">Picture This: Snapshot Testing</a>.</li>
<li><a href="https://voice.kadira.io/snapshot-testing-in-react-storybook-43b3b71cec4f" target="_blank" rel="noopener noreferrer">Snapshot testing with React Storybook</a>.</li>
<li><a href="https://medium.com/@ryancollinsio/testing-react-redux-applications-fee79ac0087f#.lyjl7st1n" target="_blank" rel="noopener noreferrer">Testing React and Redux Applications</a>.</li>
<li>If you are using the popular <a href="https://github.com/airbnb/enzyme" target="_blank" rel="noopener noreferrer">enzyme</a> testing utility, there is now a project <a href="https://github.com/trayio/enzyme-to-json" target="_blank" rel="noopener noreferrer">enzyme-to-json</a> which makes it possible to use Jest's snapshot testing feature together with enzyme.</li>
</ul>
<p><a href="https://github.com/reactjs/redux/commit/7296d3cba1f5f899bdee5ef6695a8d21149f8d6c" target="_blank" rel="noopener noreferrer">Redux itself now uses Jest</a> and Max Stoiber wrote a <a href="http://academy.plot.ly/react/6-testing/" target="_blank" rel="noopener noreferrer">tutorial on how to test code written with redux</a>. There is also a great <a href="https://semaphoreci.com/community/tutorials/how-to-test-react-and-mobx-with-jest" target="_blank" rel="noopener noreferrer">guide on how to write tests for MobX</a>. If you are using <a href="https://github.com/facebookincubator/create-react-app" target="_blank" rel="noopener noreferrer">create-react-app</a>, Jest is now included by default. Kent C. Dodds created a ton of <a href="https://egghead.io/lessons/javascript-use-jest-s-snapshot-testing-feature?pl=testing-javascript-with-jest-a36c4074" target="_blank" rel="noopener noreferrer">videos on egghead.io</a> that will help you get started with Jest.</p>
<p>If you are using other test runners, Kenneth Skovhus built an awesome <a href="https://github.com/skovhus/jest-codemods" target="_blank" rel="noopener noreferrer">jest-codemods</a> library that will automate the conversion for you. Codemods are awesome: they'll allow you to quickly evaluate whether Jest will work for you. Give it a try!</p>
<p>The full <a href="https://github.com/jestjs/jest/blob/main/CHANGELOG.md#jest-1600" target="_blank" rel="noopener noreferrer">changelog can be found on GitHub</a>. Jest 16 was a true JavaScript community effort and the project now has more than 220 contributors. We thank each and every one of you for your help to make this project great.</p>]]></content>
        <author>
            <name>Christoph Nakazawa</name>
            <uri>http://twitter.com/cpojer</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Jest 15.0: New Defaults for Jest]]></title>
        <id>https://danielorozco06.github.io/blog/2016/09/01/jest-15</id>
        <link href="https://danielorozco06.github.io/blog/2016/09/01/jest-15"/>
        <updated>2016-09-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We spent the past year making Jest faster, easier to configure, added tons of features and built snapshot testing. However, there were two areas where we invested very little we can move fast and improve the framework for Facebook and the open source community at light-speed. Jest's goal is to come with batteries included and to require as little configuration as necessary. We recently got a chance to explain our philosophy on a create-react-app issue.]]></summary>
        <content type="html"><![CDATA[<p>We spent the past year making Jest <a href="https://danielorozco06.github.io/blog/2016/03/11/javascript-unit-testing-performance">faster</a>, <a href="https://danielorozco06.github.io/blog/2016/04/12/jest-11">easier to configure</a>, <a href="https://danielorozco06.github.io/blog/2016/06/22/jest-13">added tons of features</a> and built <a href="https://danielorozco06.github.io/blog/2016/07/27/jest-14">snapshot testing</a>. However, there were two areas where we invested very little: the CLI output and user experience. With Jest 15 we are changing the framework radically to make it easier to use both for beginners and experienced users. We are excited that our investment in Jest is now paying off: we can move fast and improve the framework for Facebook and the open source community at light-speed. Jest's goal is to come with batteries included and to require as little configuration as necessary. We recently got a chance to explain our philosophy on a <a href="https://github.com/facebookincubator/create-react-app/pull/250#issuecomment-237098619" target="_blank" rel="noopener noreferrer">create-react-app issue</a>.</p>
<p>The most important change to talk about is a set of <a href="https://github.com/jestjs/jest/pull/1511" target="_blank" rel="noopener noreferrer">new defaults</a>. If you are an existing Jest user you will very likely need to update your configuration for Jest 15. In most cases it will simplify your setup and Jest will provide useful error messages during the upgrade. All of the new defaults can be disabled to suit your needs, but we still consider the disabled features critical for Jest in certain situations and will continue to use and support them at Facebook long-term. Our <a href="https://danielorozco06.github.io/docs/api">API documentation</a> was also completely rewritten to reflect these changes. <a href="https://github.com/facebook/react/pull/7625/files" target="_blank" rel="noopener noreferrer">This pull request for React</a> highlights some of the changes necessary for existing projects.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-cli-error-messages-and-summaries">New CLI error messages and summaries<a href="https://danielorozco06.github.io/blog/2016/09/01/jest-15#new-cli-error-messages-and-summaries" class="hash-link" aria-label="Direct link to New CLI error messages and summaries" title="Direct link to New CLI error messages and summaries">​</a></h2>
<p>As part of our effort to remove Jasmine incrementally within Jest, replacing all Jasmine matchers was almost completed. A lot of time was spent tweaking every error message for every matcher to give the best signal to users when a test is failing – the time when Jest should provide the most value to you. In addition to printing the expected and received values, a diff is printed for the <code>toBe</code> and <code>toEqual</code> matchers to help spot mistakes. More colors were added and relevant files from stack traces are highlighted more prominently.</p>
<p>Here is a comparison of the before and after on a light terminal: <img decoding="async" loading="lazy" alt="failure1" src="https://danielorozco06.github.io/assets/images/15-failure1-18a216b24eb5641ffe2f700795be8738.png" width="2414" height="1422" class="img_ev3q"> It also works well with darker colors: <img decoding="async" loading="lazy" alt="failure2" src="https://danielorozco06.github.io/assets/images/15-failure2-0638fb4e0e8ef964763fab8c4bebd23c.png" width="2442" height="850" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-watch-command">New watch command<a href="https://danielorozco06.github.io/blog/2016/09/01/jest-15#new-watch-command" class="hash-link" aria-label="Direct link to New watch command" title="Direct link to New watch command">​</a></h2>
<p>We completely rewrote <code>jest --watch</code> to be more interactive. It can now switch between running all tests or only test files related to changed files by pressing <code>a</code> or <code>o</code>. By pressing <code>p</code> a prompt appears that allows to specify a test pattern to focus on a specific set of files. Snapshot tests can be updated by pressing <code>u</code>.</p>
<p><img decoding="async" loading="lazy" alt="watch" src="https://danielorozco06.github.io/assets/images/15-watch-951ac33b263d3ee8522e35b8836b1f88.gif" width="858" height="575" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="jest-react-native-improvements">jest-react-native improvements<a href="https://danielorozco06.github.io/blog/2016/09/01/jest-15#jest-react-native-improvements" class="hash-link" aria-label="Direct link to jest-react-native improvements" title="Direct link to jest-react-native improvements">​</a></h2>
<p>Mocks for <code>ListView</code>, <code>TextInput</code>, <code>ActivityIndicator</code>, <code>ScrollView</code> and more were added. The existing mocks were updated to use the real implementations and existing snapshots likely have to be updated when upgrading to Jest 15. A <code>mockComponent</code> function was added to <code>jest-react-native</code> that can be used to mock native components:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f6f6"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f6f6"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">mock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'MyNativeComponent'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#888">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#297a29">const</span><span class="token plain"> jestReactNative </span><span class="token operator" style="color:#888">=</span><span class="token plain"> </span><span class="token function" style="color:#6b2e85">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'jest-react-native'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#297a29">return</span><span class="token plain"> jestReactNative</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">mockComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'MyNativeComponent'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There have also been a number of improvements around mocking images, the fetch module and other native APIs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="buffered-console-messages">Buffered Console Messages<a href="https://danielorozco06.github.io/blog/2016/09/01/jest-15#buffered-console-messages" class="hash-link" aria-label="Direct link to Buffered Console Messages" title="Direct link to Buffered Console Messages">​</a></h2>
<p>Jest parallelizes test runs across workers to maximize performance. Previously Jest used to forward console messages from workers to the parent and printed them immediately. When running multiple tests in parallel, it was often hard to find out which test and which module was calling a log function. In Jest 15, all console messages are buffered and printed together with individual test results. In addition the file and line number of the log call is printed so the code can easily be inspected.</p>
<p>Compare the output of the previous version of Jest and Jest 15: <img decoding="async" loading="lazy" alt="console" src="https://danielorozco06.github.io/assets/images/15-console-5050b2c2d39cedc5bff49baa56bb78a3.png" width="2358" height="1162" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="disabled-automocking">Disabled Automocking<a href="https://danielorozco06.github.io/blog/2016/09/01/jest-15#disabled-automocking" class="hash-link" aria-label="Direct link to Disabled Automocking" title="Direct link to Disabled Automocking">​</a></h2>
<p>Automocking is now disabled by default in Jest. This is by far the most confusing feature for new users and in many ways it doesn't make sense for small projects. We introduced automocking at Facebook and it worked great for us when unit testing was adopted in a large existing code base with few existing tests, but over time it felt like people spent more time fighting with mocked/unmocked modules than it would have taken them to write a test normally. We also noticed that library authors often require a huge number of basic modules that always have to be manually unmocked. Even for Jest itself we realized that the majority of tests had automocking disabled manually. We still believe that explicit automocking can be incredibly valuable. This change simply trades implicit mocks for explicit mocks via calls to <code>jest.mock(moduleName)</code>.</p>
<p>If you would still like to use automocking by default, enable the <code>automock</code> setting in your configuration or manually call <code>jest.enableAutomock()</code> in your test or setup file.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="test-file-patterns">Test File Patterns<a href="https://danielorozco06.github.io/blog/2016/09/01/jest-15#test-file-patterns" class="hash-link" aria-label="Direct link to Test File Patterns" title="Direct link to Test File Patterns">​</a></h2>
<p>Not everyone uses the same convention of using a <code>__tests__</code> folder to store tests. Jest 15 also looks for files ending in <code>.spec.js</code> or <code>.test.js</code>, two popular community standards. Jest 15 also removes the <code>testDirectoryName</code> and <code>testFileExtensions</code> configuration options and asks users to switch to the <code>testRegex</code> option when the old configuration options are used.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="module-registry-persistence">Module Registry Persistence<a href="https://danielorozco06.github.io/blog/2016/09/01/jest-15#module-registry-persistence" class="hash-link" aria-label="Direct link to Module Registry Persistence" title="Direct link to Module Registry Persistence">​</a></h2>
<p>Jest used to implicitly reset all modules before each test and we recommended requiring modules in <code>beforeEach</code> or inside of tests. This is useful when modules have local state that shouldn't be shared between tests. However, two big shifts happened: ES modules with the top-level <code>import</code> syntax and a renewed interest in writing stateless functional modules.</p>
<p>This has lead to numerous incompatibilities. We also noticed that at Facebook we weren't even using this implicit reset. Instead we relied on explicit calls to <code>jest.resetModules()</code> which puts engineers in control on when to wipe away all state.</p>
<p>Here is an example:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f6f6"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f6f6"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#297a29">const</span><span class="token plain"> </span><span class="token maybe-class-name">React1</span><span class="token plain"> </span><span class="token operator" style="color:#888">=</span><span class="token plain"> </span><span class="token function" style="color:#6b2e85">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'react'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">resetModules</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#297a29">const</span><span class="token plain"> </span><span class="token maybe-class-name">React2</span><span class="token plain"> </span><span class="token operator" style="color:#888">=</span><span class="token plain"> </span><span class="token function" style="color:#6b2e85">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'react'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">React1</span><span class="token plain"> </span><span class="token operator" style="color:#888">!==</span><span class="token plain"> </span><span class="token maybe-class-name">React2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// These two are separate copies of React.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The call to <code>resetModules</code> wipes away the require cache. A second call to require the same module will result in a new instantiation of the same module and all of its dependencies. This feature is especially useful when dealing with modules that have side effects, like <a href="https://github.com/jestjs/jest/blob/3bbf32a239fc4aad8cc6928a787f235bd86fecac/packages/jest-haste-map/src/__tests__/index-test.js#L64" target="_blank" rel="noopener noreferrer">jest-haste-map</a>.</p>
<p>We believe it is better to put users in control so we disabled the implicit reset. Modules can be reset using <code>jest.resetModules()</code> in code and the <code>resetModules</code> option can be enabled in the configuration to bring back the previous behavior.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="real-vs-fake-timers">Real vs Fake Timers<a href="https://danielorozco06.github.io/blog/2016/09/01/jest-15#real-vs-fake-timers" class="hash-link" aria-label="Direct link to Real vs Fake Timers" title="Direct link to Real vs Fake Timers">​</a></h2>
<p>By default Jest used to mock all timer functions like <code>setTimeout</code> or <code>process.nextTick</code> and provided an API <code>jest.runAllTimers()</code> to advance timers programatically. This is useful when a piece of code sets a long timeout that we don't want to wait for in a test.</p>
<p>However we found that most of the time the use cases are quite isolated. <a href="https://danielorozco06.github.io/docs/tutorial-async">Async programming</a> has also become much simpler in our test runner. Jest now uses the real timers by default.</p>
<p>You can still override this by specifying <code>"timers": "fake"</code> in the configuration or by calling <code>jest.useRealTimers()</code> and <code>jest.useFakeTimers()</code> global switches.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="setupenvscriptfile-vs-setupfiles">setupEnvScriptFile vs setupFiles<a href="https://danielorozco06.github.io/blog/2016/09/01/jest-15#setupenvscriptfile-vs-setupfiles" class="hash-link" aria-label="Direct link to setupEnvScriptFile vs setupFiles" title="Direct link to setupEnvScriptFile vs setupFiles">​</a></h2>
<p>The <code>setupEnvScriptFile</code> configuration option has been deprecated for a while. Jest 15 removes it completely and replaces it with <code>setupFiles</code>. This option expects an array of file paths that are loaded in order before a test file is executed.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rewritten-code-coverage-support">Rewritten Code Coverage Support<a href="https://danielorozco06.github.io/blog/2016/09/01/jest-15#rewritten-code-coverage-support" class="hash-link" aria-label="Direct link to Rewritten Code Coverage Support" title="Direct link to Rewritten Code Coverage Support">​</a></h2>
<p>Code coverage in Jest can be used through <code>jest --coverage</code> and requires no additional packages or configuration. Code coverage support was completely rewritten and a new <code>collectCoverageFrom</code> option was added to collect code coverage information from entire projects, including <strong>untested files</strong>. Note that this option uses globs as we are hoping to further simplify configuration options in the future and provide a simpler alternative to regular expressions. See Jest's <a href="https://github.com/jestjs/jest/blob/9088f6517813f6c089cf52e980d6579511dcde88/package.json#L47" target="_blank" rel="noopener noreferrer">package.json</a> for an example.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-improvements">Other Improvements<a href="https://danielorozco06.github.io/blog/2016/09/01/jest-15#other-improvements" class="hash-link" aria-label="Direct link to Other Improvements" title="Direct link to Other Improvements">​</a></h2>
<p>A huge number of other improvements were also made:</p>
<ul>
<li>Improved performance of small test runs.</li>
<li>Jest now uses verbose mode when only a single test file is executed.</li>
<li>Added an <code>--env</code> option to override the configured test environment.</li>
<li><code>moduleNameMapper</code> now uses a resolution algorithm.</li>
<li>Jest now works with paths that have special characters in them, like parenthesis.</li>
<li>Added <code>global.global</code> to the node environment.</li>
<li>Fixed <code>babel-plugin-jest-hoist</code>'s invalid error when a random user function was called <code>mock</code>.</li>
<li>Fix <code>testEnvironment</code> resolution to prefer <code>jest-environment-{name}</code> instead of <code>{name}</code> only. This prevents a module collision when using <code>jsdom</code> as test environment.</li>
<li>Improvements to Jest's own test infra by merging integration and unit tests. Code coverage is now collected for Jest.</li>
</ul>
<p>We are happy when looking back at all the changes we have made together with the help from the community and couldn't be more excited to make Jest even better over the course of the next few months. Please <a href="https://github.com/jestjs/jest/issues" target="_blank" rel="noopener noreferrer">file an issue</a> if something isn't working as expected and send us pull requests.</p>
<p>Next up: <a href="https://github.com/jestjs/jest/pull/1480" target="_blank" rel="noopener noreferrer">Concurrent Reporter</a>.</p>]]></content>
        <author>
            <name>Christoph Nakazawa</name>
            <uri>http://twitter.com/cpojer</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Jest 14.0: React Tree Snapshot Testing]]></title>
        <id>https://danielorozco06.github.io/blog/2016/07/27/jest-14</id>
        <link href="https://danielorozco06.github.io/blog/2016/07/27/jest-14"/>
        <updated>2016-07-27T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[One of Jest's philosophies is to provide an integrated “zero-configuration” experience. We want to make it as frictionless as possible to write good tests that are useful. We observed that when engineers are provided with ready-to-use tools, they end up writing more tests, which in turn results in stable and healthy code bases.]]></summary>
        <content type="html"><![CDATA[<p>One of Jest's philosophies is to provide an integrated “zero-configuration” experience. We want to make it as frictionless as possible to write good tests that are useful. We observed that when engineers are provided with ready-to-use tools, they end up writing more tests, which in turn results in stable and healthy code bases.</p>
<p>One of the big open questions was how to write React tests efficiently. There are plenty of tools such as <a href="https://facebook.github.io/react/docs/test-utils.html" target="_blank" rel="noopener noreferrer">ReactTestUtils</a> and <a href="https://enzymejs.github.io/enzyme/" target="_blank" rel="noopener noreferrer">enzyme</a>. Both of these tools are great and are actively being used. However engineers frequently told us that they spend more time writing a test than the component itself. As a result many people stopped writing tests altogether which eventually led to instabilities. Engineers told us all they wanted was to make sure their components don't change unexpectedly.</p>
<p>Together with the React team we created a new test renderer for React and added snapshot testing to Jest. Consider this <a href="https://github.com/jestjs/jest/blob/main/examples/snapshot/__tests__/link.test.js" target="_blank" rel="noopener noreferrer">example test</a> for a simple <a href="https://github.com/jestjs/jest/blob/main/examples/snapshot/Link.js" target="_blank" rel="noopener noreferrer">Link component</a>:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f6f6"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f6f6"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#297a29">import</span><span class="token plain"> </span><span class="token imports">renderer</span><span class="token plain"> </span><span class="token keyword module" style="color:#297a29">from</span><span class="token plain"> </span><span class="token string" style="color:#c21325">'react-test-renderer'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#6b2e85">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'Link renders correctly'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#888">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#297a29">const</span><span class="token plain"> tree </span><span class="token operator" style="color:#888">=</span><span class="token plain"> renderer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#888">&lt;</span><span class="token maybe-class-name">Link</span><span class="token plain"> page</span><span class="token operator" style="color:#888">=</span><span class="token string" style="color:#c21325">"http://www.facebook.com"</span><span class="token operator" style="color:#888">&gt;</span><span class="token maybe-class-name">Facebook</span><span class="token operator" style="color:#888">&lt;</span><span class="token operator" style="color:#888">/</span><span class="token maybe-class-name">Link</span><span class="token operator" style="color:#888">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">toJSON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#6b2e85">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tree</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">toMatchSnapshot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The first time this test is run, Jest creates a <a href="https://github.com/jestjs/jest/blob/main/examples/snapshot/__tests__/__snapshots__/link.test.js.snap" target="_blank" rel="noopener noreferrer">snapshot file</a> that looks like this:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f6f6"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f6f6"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">exports</span><span class="token punctuation" style="color:#393A34">[</span><span class="token template-string template-punctuation string" style="color:#c21325">`</span><span class="token template-string string" style="color:#c21325">Link renders correctly 1</span><span class="token template-string template-punctuation string" style="color:#c21325">`</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#888">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#c21325">`</span><span class="token template-string string" style="color:#c21325"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#c21325">&lt;a</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#c21325">  className="normal"</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#c21325">  href="http://www.facebook.com"</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#c21325">  onMouseEnter={[Function bound _onMouseEnter]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#c21325">  onMouseLeave={[Function bound _onMouseLeave]}&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#c21325">  Facebook</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#c21325">&lt;/a&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#c21325"></span><span class="token template-string template-punctuation string" style="color:#c21325">`</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The snapshot artifact should be committed alongside code changes. We use <a href="https://github.com/thejameskyle/pretty-format" target="_blank" rel="noopener noreferrer">pretty-format</a> to make snapshots human-readable during code review. On subsequent test runs Jest will simply compare the rendered output with the previous snapshot. If they match, the test will pass. If they don't match, either the implementation has changed and the snapshot needs to be updated with <code>jest -u</code>, or the test runner found a bug in your code that should be fixed.</p>
<p>If we change the address the Link component in our example is pointing to, Jest will print this output:</p>
<p><img decoding="async" loading="lazy" alt="snapshot-testing" src="https://danielorozco06.github.io/assets/images/snapshot-8de6b9bafc9754f21e3c61604fc0623c.png" width="1450" height="546" class="img_ev3q"></p>
<p>Now you know that you either need to accept the changes with <code>jest -u</code>, or fix the component if the changes were unintentional. To try out this functionality, please clone the <a href="https://github.com/jestjs/jest/tree/main/examples/snapshot" target="_blank" rel="noopener noreferrer">snapshot example</a>, modify the Link component and run Jest. We updated the <a href="https://danielorozco06.github.io/docs/tutorial-react">React Tutorial</a> with a new guide for snapshot testing.</p>
<p>This feature was built by <a href="https://twitter.com/soprano" target="_blank" rel="noopener noreferrer">Ben Alpert</a> and <a href="https://twitter.com/kentaromiura" target="_blank" rel="noopener noreferrer">Cristian Carlesso</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="experimental-react-native-support">Experimental React Native support<a href="https://danielorozco06.github.io/blog/2016/07/27/jest-14#experimental-react-native-support" class="hash-link" aria-label="Direct link to Experimental React Native support" title="Direct link to Experimental React Native support">​</a></h2>
<p>By building a test renderer that targets no specific platform we are finally able to support a full, unmocked version of React Native. We are excited to launch experimental React Native support for Jest through the <code>jest-react-native</code> package.</p>
<p>You can start using Jest with react-native by running <code>yarn add --dev jest-react-native</code> and by adding the preset to your Jest configuration:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f6f6"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f6f6"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token property" style="color:#82772c">"jest"</span><span class="token operator" style="color:#888">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#82772c">"preset"</span><span class="token operator" style="color:#888">:</span><span class="token plain"> </span><span class="token string" style="color:#c21325">"jest-react-native"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><a href="https://danielorozco06.github.io/docs/tutorial-react-native#content">Tutorial and setup guide</a></li>
<li><a href="https://github.com/jestjs/jest/tree/main/examples/react-native" target="_blank" rel="noopener noreferrer">Example project</a></li>
<li><a href="https://github.com/bartonhammond/snowflake/pull/110" target="_blank" rel="noopener noreferrer">Example pull request for <em>snowflake</em></a>, a popular react-native open source library.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The preset currently only implements the minimal set of configuration necessary to get started with React Native testing. We are hoping for community contributions to improve this project. Please try it and file <a href="https://github.com/jestjs/jest/issues" target="_blank" rel="noopener noreferrer">issues</a> or send pull requests!</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-snapshot-testing">Why snapshot testing?<a href="https://danielorozco06.github.io/blog/2016/07/27/jest-14#why-snapshot-testing" class="hash-link" aria-label="Direct link to Why snapshot testing?" title="Direct link to Why snapshot testing?">​</a></h2>
<p>For Facebook's native apps we use a system called “snapshot testing”: a snapshot test system that renders UI components, takes a screenshot and subsequently compares a recorded screenshot with changes made by an engineer. If the screenshots don't match, there are two possibilities: either the change is unexpected or the screenshot can be updated to the new version of the UI component.</p>
<p>While this was the solution we wanted for the web, we also found many problems with such end-to-end tests that snapshot integration tests solve:</p>
<ul>
<li><strong>No flakiness:</strong> Because tests are run in a command line runner instead of a real browser or on a real phone, the test runner doesn't have to wait for builds, spawn browsers, load a page and drive the UI to get a component into the expected state which tends to be flaky and the test results become noisy.</li>
<li><strong>Fast iteration speed:</strong> Engineers want to get results in less than a second rather than waiting for minutes or even hours. If tests don't run quickly like in most end-to-end frameworks, engineers don't run them at all or don't bother writing them in the first place.</li>
<li><strong>Debugging:</strong> It's easy to step into the code of an integration test in JS instead of trying to recreate the screenshot test scenario and debugging what happened in the visual diff.</li>
</ul>
<p>Because we believe snapshot testing can be useful beyond Jest we split the feature into a <a href="https://github.com/jestjs/jest/tree/main/packages/jest-snapshot" target="_blank" rel="noopener noreferrer">jest-snapshot</a> package. We are happy to work with the community to make it more generic so it can be integrated with other test runners and share concepts and infrastructure with each other.</p>
<p>Finally, here is a quote of a Facebook engineer describing how snapshot testing changed his unit testing experience:</p>
<blockquote>
<p>“One of the most challenging aspects of my project was keeping the input and output files for each test case in sync. Each little change in functionality could cause all the output files to change. With snapshot testing I do not need the output files, the snapshots are generated for free by Jest! I can simply inspect how Jest updates the snapshots rather than making the changes manually.” – <a href="https://github.com/kyldvs" target="_blank" rel="noopener noreferrer">Kyle Davis</a> working on <a href="https://github.com/kyldvs/fjs" target="_blank" rel="noopener noreferrer">fjs</a>.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-next-for-jest">What's next for Jest<a href="https://danielorozco06.github.io/blog/2016/07/27/jest-14#whats-next-for-jest" class="hash-link" aria-label="Direct link to What's next for Jest" title="Direct link to What's next for Jest">​</a></h2>
<p>Recently <a href="https://twitter.com/aarondjents" target="_blank" rel="noopener noreferrer">Aaron Abramov</a> has joined the Jest team full time to improve our unit and integration test infrastructure for Facebook's ads products. For the next few months the Jest team is planning major improvements in these areas:</p>
<ul>
<li><strong>Replace Jasmine:</strong> Jasmine is slowing us down and is not being very actively developed. We started replacing all the Jasmine matchers and are excited to add new features and drop this dependency.</li>
<li><strong>Code Coverage:</strong> When Jest was originally created, tools such as babel didn't exist. Our code coverage support has a bunch of edge cases and isn't always working properly. We are rewriting it to address all the current problems with coverage.</li>
<li><strong>Developer Experience:</strong> This ranges from improving the setup process, the debugging experience to CLI improvements and more documentation.</li>
<li><strong>Mocking:</strong> The mocking system, especially around manual mocks, is not working well and is confusing. We hope to make it more strict and easier to understand.</li>
<li><strong>Performance:</strong> Further performance improvements especially for really large codebases are being worked on.</li>
</ul>
<p>As always, if you have questions or if you are excited to help out, please reach out to us!</p>]]></content>
        <author>
            <name>Christoph Nakazawa</name>
            <uri>http://twitter.com/cpojer</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Jest 13.0: Flow & REPL]]></title>
        <id>https://danielorozco06.github.io/blog/2016/06/22/jest-13</id>
        <link href="https://danielorozco06.github.io/blog/2016/06/22/jest-13"/>
        <updated>2016-06-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Today we are happy to announce the next major release of Jest. We have made major changes to Jest which are going to benefit you and all of Facebook's JavaScript test infrastructure. Most importantly, we added static types to all of Jest's code during a recent Jest hackathon at Facebook. Fifteen people worked for a day and night to add Flow types to Jest and to add new features to Jest. The Flow types serve two purposes: First, we believe that code is written to be read. Most of the time, code is written only once but read by dozens of people over the course of years. Adding static types to the project helps document the code and helps explain some of the architecture in Jest. Second, adding static types makes maintenance easier and will allow us to more confidently refactor parts of Jest without fear of breakages.]]></summary>
        <content type="html"><![CDATA[<p>Today we are happy to announce the next major release of Jest. We have made major changes to Jest which are going to benefit you and all of Facebook's JavaScript test infrastructure. Most importantly, we added static types to all of Jest's code during a recent Jest hackathon at Facebook. Fifteen people worked for a day and night to add <a href="https://flowtype.org/" target="_blank" rel="noopener noreferrer">Flow</a> types to Jest and to add new features to Jest. The Flow types serve two purposes: First, we believe that code is written to be read. Most of the time, code is written only once but read by dozens of people over the course of years. Adding static types to the project helps document the code and helps explain some of the architecture in Jest. Second, adding static types makes maintenance easier and will allow us to more confidently refactor parts of Jest without fear of breakages.</p>
<p>The Flow project has evolved a lot within Facebook and has been successfully adopted across many of our frameworks and almost all of our product code. Adoption can be parallelized incredibly well – it can be done file-by-file until enough of the codebase is well-typed. Then, Flow provides real value and helps guide through large changes. Through this, many small edge cases and bugs were found.</p>
<p>With the help of <a href="https://github.com/lerna/lerna" target="_blank" rel="noopener noreferrer">lerna</a>, we continued to modularize the Jest project. With just a small <a href="https://github.com/lerna/lerna#lernajson" target="_blank" rel="noopener noreferrer">update to the configuration</a>, Flow and lerna now get along well with each other. Splitting up Jest into packages helped us rethink module boundaries and enabled us to ship useful <a href="https://github.com/jestjs/jest/tree/main/packages" target="_blank" rel="noopener noreferrer">packages</a> standalone: The <code>jest-runtime</code> and <code>jest-repl</code> cli tools now allow you to run scripts in a sandboxed Jest environment, enabling you to run and debug your app from the command line. This is especially helpful for projects that use Facebook's <code>@providesModule</code> module convention. To get started, just install <code>jest-repl</code> and run it in the same folder you normally run your tests in! We also published a <code>jest-changed-files</code> package that finds changed files in version control for either git or hg, a common thing in developer tools.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-and-improved-features">New and improved features<a href="https://danielorozco06.github.io/blog/2016/06/22/jest-13#new-and-improved-features" class="hash-link" aria-label="Direct link to New and improved features" title="Direct link to New and improved features">​</a></h2>
<ul>
<li>Added a notification plugin that shows a test run notification when using <code>--notify</code>.</li>
<li>Added a <code>browser</code> config option to properly resolve npm packages with a browser field in <code>package.json</code> if you are writing tests for client side apps.</li>
<li>Improved “no tests found message” which will now report which tests were found and how they were filtered.</li>
<li>Added <code>jest.isMockFunction(jest.fn())</code> to test for mock functions.</li>
<li>Improved test reporter printing and added a test failure summary when running many tests.</li>
<li>Added support for mocking virtual modules through <code>jest.mock('Module', implementation, {virtual: true})</code>.</li>
<li>Removed the <code>.haste_cache</code> folder. Jest now uses the operating system's preferred temporary file location.</li>
<li>Added the duration of individual tests in verbose mode.</li>
<li>Added the ability to record snapshots in Jest. We'll be publishing a separate blog post about this feature soon.</li>
</ul>
<p>Finally, we have received a complete website redesign done by Matthew Johnston and added documentation for using <a href="https://danielorozco06.github.io/docs/webpack">Jest with webpack</a>. Happy Jesting!</p>]]></content>
        <author>
            <name>Christoph Nakazawa</name>
            <uri>http://twitter.com/cpojer</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Jest 11.0]]></title>
        <id>https://danielorozco06.github.io/blog/2016/04/12/jest-11</id>
        <link href="https://danielorozco06.github.io/blog/2016/04/12/jest-11"/>
        <updated>2016-04-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Today we're announcing a switch to major revisions for Jest with Jest 11.0 being the first major release. Jest has been used by Facebook engineers and on our continuous integration systems for years and we believe Jest has been way beyond a “1.0 release” for a long time. This is similar to a change the React team has made.]]></summary>
        <content type="html"><![CDATA[<p>Today we're announcing a switch to major revisions for Jest with Jest 11.0 being the first major release. Jest has been used by Facebook engineers and on our continuous integration systems for years and we believe Jest has been way beyond a “1.0 release” for a long time. This is similar to a change <a href="http://facebook.github.io/react/blog/2016/02/19/new-versioning-scheme.html" target="_blank" rel="noopener noreferrer">the React team has made</a>.</p>
<p>If you are using Jest 0.9 or Jest 0.10 the upgrade should be seamless. All changes from the last few months were rolled into Jest 11.0.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="new-in-jest-110">New in Jest 11.0<a href="https://danielorozco06.github.io/blog/2016/04/12/jest-11#new-in-jest-110" class="hash-link" aria-label="Direct link to New in Jest 11.0" title="Direct link to New in Jest 11.0">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="babel-integration-and-simplified-setup">Babel Integration and Simplified Setup<a href="https://danielorozco06.github.io/blog/2016/04/12/jest-11#babel-integration-and-simplified-setup" class="hash-link" aria-label="Direct link to Babel Integration and Simplified Setup" title="Direct link to Babel Integration and Simplified Setup">​</a></h4>
<p><code>babel-jest</code> was adopted within the newly modularized Jest <a href="https://github.com/jestjs/jest/tree/main/packages" target="_blank" rel="noopener noreferrer">repository</a> and it is now seamlessly integrated into Jest. If you are upgrading from an older version of Jest or are looking to adopt Jest, we recommend reading the <a href="https://danielorozco06.github.io/docs/getting-started">Getting Started guide</a>.</p>
<p>Previously Jest provided APIs such as <code>jest.dontMock</code> which unmocks a module that is subsequently being required using the <code>require</code> function. Testing code usually looked like this:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f6f6"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f6f6"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">dontMock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'LikeButton'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#297a29">const</span><span class="token plain"> </span><span class="token maybe-class-name">LikeButton</span><span class="token plain"> </span><span class="token operator" style="color:#888">=</span><span class="token plain"> </span><span class="token function" style="color:#6b2e85">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'LikeButton'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// LikeButton is unmocked</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>However, together with ES2015 import statements this will no longer work. Per the specification <code>import</code>s are hoisted to the top of their code block. Code written like this:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f6f6"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f6f6"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">dontMock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'LikeButton'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#297a29">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">LikeButton</span><span class="token plain"> </span><span class="token keyword module" style="color:#297a29">from</span><span class="token plain"> </span><span class="token string" style="color:#c21325">'LikeButton'</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>when executed, would actually be run in this order:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f6f6"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f6f6"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#297a29">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">LikeButton</span><span class="token plain"> </span><span class="token keyword module" style="color:#297a29">from</span><span class="token plain"> </span><span class="token string" style="color:#c21325">'LikeButton'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// This happens before the dontMock call.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">dontMock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'LikeButton'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The LikeButton module would therefore be mocked even though we explicitly call <code>dontMock</code>.</p>
<p>When the latest versions of Jest and babel-jest are used together, calls to the new APIs <code>jest.unmock</code>, <code>jest.mock</code>, <code>jest.disableAutomock</code> and <code>jest.enableAutomock</code> are hoisted to the top of their block, before ES2015 import statements.</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f6f6"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f6f6"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">unmock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'LikeButton'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#297a29">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">LikeButton</span><span class="token plain"> </span><span class="token keyword module" style="color:#297a29">from</span><span class="token plain"> </span><span class="token string" style="color:#c21325">'LikeButton'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// LikeButton is properly unmocked!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="automocking-improvements">(Auto)Mocking Improvements<a href="https://danielorozco06.github.io/blog/2016/04/12/jest-11#automocking-improvements" class="hash-link" aria-label="Direct link to (Auto)Mocking Improvements" title="Direct link to (Auto)Mocking Improvements">​</a></h4>
<p>We have made numerous improvements and bug fixes to Jest's automocking feature, improved npm3 support and added new manual mocking APIs. Many people have expressed a desire use Jest with the automocking feature disabled. A global configuration option <a href="https://danielorozco06.github.io/docs/api#automock-boolean"><code>automock</code></a>, which can be set to <code>false</code>, was added.</p>
<p>We have also added two new APIs to simplify manual mocks. <code>jest.mock</code> specifies a manual mock factory for a specific test:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f6f6"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f6f6"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Implement a mock for a hypothetical "sum" module.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">mock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'sum'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#888">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#297a29">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">a</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#888">=&gt;</span><span class="token plain"> a </span><span class="token operator" style="color:#888">+</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#297a29">const</span><span class="token plain"> sum </span><span class="token operator" style="color:#888">=</span><span class="token plain"> </span><span class="token function" style="color:#6b2e85">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'sum'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#6b2e85">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#1373c2">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#1373c2">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And <code>jest.fn</code> was added to make it easier to create mock functions:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f6f6"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f6f6"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Create a mock function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#297a29">const</span><span class="token plain"> mockFn </span><span class="token operator" style="color:#888">=</span><span class="token plain"> jest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">fn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#888">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#1373c2">42</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#6b2e85">mockFn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 42</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#6b2e85">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mockFn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">calls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">toBe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#1373c2">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="performance">Performance<a href="https://danielorozco06.github.io/blog/2016/04/12/jest-11#performance" class="hash-link" aria-label="Direct link to Performance" title="Direct link to Performance">​</a></h4>
<p>We recently wrote about some <a href="https://danielorozco06.github.io/blog/2016/03/11/javascript-unit-testing-performance">performance improvements</a> we've made in Jest. Most notably, startup time has been improved and we are now in a comfortable place with regards to performance.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="jasmine-and-test-assertion-improvements">Jasmine and Test Assertion Improvements<a href="https://danielorozco06.github.io/blog/2016/04/12/jest-11#jasmine-and-test-assertion-improvements" class="hash-link" aria-label="Direct link to Jasmine and Test Assertion Improvements" title="Direct link to Jasmine and Test Assertion Improvements">​</a></h4>
<p>When Jest was open sourced it shipped with Jasmine 1. Jest was designed to work with any test assertion library and optional Jasmine 2 support was added through an <a href="https://github.com/jestjs/jest/pull/330" target="_blank" rel="noopener noreferrer">external contribution</a> at the end of last year. This change delivers better performance and provides a better APIs over the previous version of Jasmine. As such, we have converted all our JavaScript tests at Facebook to Jasmine 2. With Jest 11 we are making Jasmine 2 the new default. Jasmine 1 can be enabled through the <a href="https://danielorozco06.github.io/docs/api#testrunner-string"><code>testRunner</code></a> configuration option.</p>
<p>We have also made many updates around Jasmine. The failure messages for custom matchers provided for Jest's mock functions were improved and will now also work for Jasmine spies. Skipped tests, when using <code>fit</code> or <code>fdescribe,</code> are now properly reported at the end of a test run.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="other-changes">Other Changes<a href="https://danielorozco06.github.io/blog/2016/04/12/jest-11#other-changes" class="hash-link" aria-label="Direct link to Other Changes" title="Direct link to Other Changes">​</a></h4>
<p>The <code>jest --watch</code> command has been rewritten and improved. By default it now only runs tests related to changed files. If you want to run all tests on every change, you can run <code>jest --watch=all</code>. The verbose logger output has also been improved and we've added more helpful warnings and error messages. We added a <a href="https://danielorozco06.github.io/docs/api#testenvironment-string"><code>testEnvironment</code></a> configuration option to customize the test environment. For example, when building a node service, a special <code>node</code> environment instead of <code>jsdom</code> can be used. Finally, the website and all documentation have been completely rewritten.</p>
<p>All changes from the past few months can be found in the <a href="https://github.com/jestjs/jest/blob/main/CHANGELOG.md" target="_blank" rel="noopener noreferrer">CHANGELOG</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="contributions-and-jests-future">Contributions And Jest's future<a href="https://danielorozco06.github.io/blog/2016/04/12/jest-11#contributions-and-jests-future" class="hash-link" aria-label="Direct link to Contributions And Jest's future" title="Direct link to Contributions And Jest's future">​</a></h3>
<p>Over the last six months, Jest has received significant changes from a huge number of new contributors. I'd like to thank all the open source contributors and Facebook employees for their help in making Jest better for everyone. New contributors: Alexander Juarez, Christian Lentfort, Cristian Carlesso, Dan Abramov, Dmitrii Abramov, Evan Jacobs, James Friend, James Ide, Jeff Carpenter, Joe Lencioni, Michael Diolosa, Nik Graf, Pavel Prokopenko, Pavel Volokitin, Sebastian Mayr and ShihChi Huang.</p>
<p>With your support we are looking forward to making Jest even better in the coming months. We are currently working on improved React (Native) testing, enhanced code coverage support and are planning to open source our internal test runner that allows multiple Jest projects to be run with a single run-command.</p>]]></content>
        <author>
            <name>Christoph Nakazawa</name>
            <uri>http://twitter.com/cpojer</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[JavaScript Unit Testing Performance]]></title>
        <id>https://danielorozco06.github.io/blog/2016/03/11/javascript-unit-testing-performance</id>
        <link href="https://danielorozco06.github.io/blog/2016/03/11/javascript-unit-testing-performance"/>
        <updated>2016-03-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Jest is running thousands of tests at Facebook at all times, either through continuous integration or invoked by engineers manually during development. This worked well for years even as the people working on Jest moved on to other projects within Facebook.]]></summary>
        <content type="html"><![CDATA[<p>Jest is running thousands of tests at Facebook at all times, either through continuous integration or invoked by engineers manually during development. This worked well for years even as the people working on Jest moved on to other projects within Facebook.</p>
<p>As engineers added more and more tests though, we noticed the performance of Jest wasn't going to scale. Additionally, in the last year the JavaScript ecosystem has changed dramatically with the introduction of things like npm3 and Babel, which we hadn't anticipated. We formed a new Jest team to address all of these issues and we'll be sharing our progress and plans on this blog from now on.</p>
<p>Jest is a bit different from most test runners. We designed it to work well in the context of Facebook's infrastructure:</p>
<ul>
<li><strong>Monorepo</strong> At Facebook we have a huge monorepo that contains all of our JavaScript code. There are many reasons why this approach is advantageous for us and there is an <a href="https://www.youtube.com/watch?v=W71BTkUbdqE" target="_blank" rel="noopener noreferrer">awesome talk</a> by a Google engineer that highlights all the benefits and drawbacks of monorepos.</li>
<li><strong>Sandboxing</strong> Another feature of Jest that's important to Facebook is how it virtualizes the test environment and wraps <code>require</code> in order to sandbox code execution and isolate individual tests. We're even working on making Jest more modular so we can take advantage of this functionality in other non-testing related use cases.</li>
<li><strong>providesModule</strong> If you've looked at any of our open source JavaScript projects before, you may have noticed that we use a <code>@providesModule</code> header to assign globally unique IDs to modules. This does require some custom tooling, but it allows us to reference modules without relative paths which has helped us move incredibly fast, has scaled well as our engineering organization has grown, and has fostered code sharing across the entire company. Check out <a href="https://github.com/facebook/relay/blob/4eae620d86ed7fce1ee463c2fca88eb690d9cbde/src/container/RelayContainer.js#L9" target="_blank" rel="noopener noreferrer">RelayContainer</a> for an example of how this works in practice. One downside to this approach, though, is that we're forced to read and parse our entire JavaScript codebase in order to resolve a single require statement. This would obviously be prohibitively expensive without extensive caching, especially for a short-lived process like Jest.</li>
</ul>
<p>As a result of these unique constraints, Jest may never be able to be as fast as other test runners when running on our entire suite of tests. However, engineers rarely need to run Jest on our entire test suite. Powered by static analysis in the <a href="https://github.com/facebook/node-haste" target="_blank" rel="noopener noreferrer">node-haste</a> project – we've been able to make the default mode for running Jest at Facebook <code>jest --onlyChanged</code>, or <code>jest -o</code>. In this mode we build a reverse dependency graph to find only the affected tests that need to be run based on the modules that have been changed.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="optimal-scheduling-of-a-test-run">Optimal Scheduling of a Test Run<a href="https://danielorozco06.github.io/blog/2016/03/11/javascript-unit-testing-performance#optimal-scheduling-of-a-test-run" class="hash-link" aria-label="Direct link to Optimal Scheduling of a Test Run" title="Direct link to Optimal Scheduling of a Test Run">​</a></h2>
<p>Most of the time our static analysis determines that more than one test needs to be run. The number of affected tests can be anywhere from a couple of tests to thousands. In order to speed this process up Jest parallelizes test runs across workers. This is great because most of Facebook's development happens on remote servers with many CPU cores.</p>
<p>Recently we noticed Jest often seemed stuck <em>“Waiting for 3 tests”</em> for up to a minute toward the end of a run. It turned out we had a few really slow tests in our codebase that were dominating the test runtime. While we were able to speed these individual tests up significantly, we also made a change in how Jest schedules test runs. Previously we used to schedule test runs based on file system traversal, which was actually quite random. Here is an example of 11 tests in gray blocks over two workers. The size of the block is the runtime of the test:</p>
<p><img decoding="async" loading="lazy" alt="perf-basic-scheduling" src="data:image/png;base64,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" width="1274" height="427" class="img_ev3q"></p>
<p>We were randomly running a mix of fast and slow tests, and one of our slowest tests ended up running as almost all the other tests were completed, during which the second worker sat idle.</p>
<p>We made a change to schedule tests based on their file size which is usually a good proxy for how long a test is going to take. A test with a few thousand lines of code likely takes longer than a test with 15 lines of code. While this sped up the entire test run by about 10%, we ended up finding a better heuristic: now Jest stores the runtime of each test in a cache and on subsequent runs, it schedules the slowest tests to run first. Overall this helped improve the runtime of all tests by about 20%.</p>
<p>Here is an example of the same test run from before with better scheduling:</p>
<p><img decoding="async" loading="lazy" alt="perf-improved-scheduling" src="data:image/png;base64,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" width="1274" height="427" class="img_ev3q"></p>
<p>Because we are running slow tests first, Jest can sometimes seem to take a long time to start up – we only print results after the first test has completed. For the future we are planning to run previously failed tests first, because getting that info to developers as quickly as possible matters the most.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="inline-requires-and-lazy-mocking">Inline Requires and Lazy Mocking<a href="https://danielorozco06.github.io/blog/2016/03/11/javascript-unit-testing-performance#inline-requires-and-lazy-mocking" class="hash-link" aria-label="Direct link to Inline Requires and Lazy Mocking" title="Direct link to Inline Requires and Lazy Mocking">​</a></h2>
<p>If you have written tests using Jasmine before, they probably look like this:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f6f6"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f6f6"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#297a29">const</span><span class="token plain"> sum </span><span class="token operator" style="color:#888">=</span><span class="token plain"> </span><span class="token function" style="color:#6b2e85">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'sum'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#6b2e85">describe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'sum'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#888">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#6b2e85">it</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'works'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#888">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#6b2e85">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#6b2e85">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#1373c2">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#1373c2">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">toBe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#1373c2">9</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>One special thing we do in Jest is reset the entire module registry after every single test (call to <code>it</code>) to make sure tests don't depend on each other. Before Jest, individual tests would depend on each other and internal module state often leaked between them. As engineers removed, reordered or refactored tests, some of them started to fail, making it hard for people to understand what was going on.</p>
<p>Every single test in Jest receives a fresh new copy of all modules, including new versions of all mocked dependencies which take a lot of time to generate for each test. A side effect of this is that we had to call <code>require</code> manually before every test, like this:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f6f6"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f6f6"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#297a29">let</span><span class="token plain"> sum</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#6b2e85">describe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'sum'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#888">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#6b2e85">beforeEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#888">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sum </span><span class="token operator" style="color:#888">=</span><span class="token plain"> </span><span class="token function" style="color:#6b2e85">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'sum'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#6b2e85">it</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'works'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#888">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#6b2e85">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#6b2e85">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#1373c2">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#1373c2">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">toBe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#1373c2">9</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#6b2e85">it</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'works too'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#888">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// This copy of sum is not the same as in the previous call to `it`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#6b2e85">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#6b2e85">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#1373c2">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#1373c2">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">toBe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#1373c2">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We built a babel transform called <a href="https://github.com/facebook/fbjs/blob/main/packages/babel-preset-fbjs/plugins/inline-requires.js" target="_blank" rel="noopener noreferrer">inline-requires</a> that removes top-level require statements and inlines them in code. For example, the line <code>const sum = require('sum');</code> will be removed from code, but every use of <code>sum</code> in the file will be replaced by <code>require('sum')</code>. With this transform we can write tests just like you'd expect in Jasmine and the code gets transformed into this:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f6f6"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f6f6"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#6b2e85">describe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'sum'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#888">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#6b2e85">it</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'works'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#888">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#6b2e85">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#6b2e85">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#c21325">'sum'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#1373c2">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#1373c2">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#6b2e85">toBe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#1373c2">9</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A great side-effect of inline requires is that we only require the modules that we actually use within the test itself, instead of all the modules we used in the entire file.</p>
<p>Which leads to another optimization: lazy mocking. The idea is to only mock modules on demand, which combined with inline requires saves us from mocking a lot of modules and all their recursive dependencies.</p>
<p>We were able to update all tests using a <a href="https://github.com/cpojer/js-codemod/blob/master/transforms/outline-require.js" target="_blank" rel="noopener noreferrer">codemod</a> in no time – it was a <em>simple</em> 50,000 line code change. Inline requires and lazy mocking improved the test runtime by 50%.</p>
<p>The inline-require babel plugin is not only useful for Jest but for normal JavaScript as well. It was shipped by <a href="https://twitter.com/voideanvalue" target="_blank" rel="noopener noreferrer">Bhuwan</a> to all users of <a href="http://facebook.com/" target="_blank" rel="noopener noreferrer">facebook.com</a> just a week ago and significantly improved startup time.</p>
<p>For now, if you'd like to use this transform in Jest you'll have to add it manually to your Babel configuration. We are working on ways to make this easier to opt-in.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="repo-sync-and-caching">Repo-Sync and Caching<a href="https://danielorozco06.github.io/blog/2016/03/11/javascript-unit-testing-performance#repo-sync-and-caching" class="hash-link" aria-label="Direct link to Repo-Sync and Caching" title="Direct link to Repo-Sync and Caching">​</a></h2>
<p>The open source version of Jest used to be a fork of our internal version, and we'd sync Jest out only once every couple of months. This was a painful manual process that required fixing up many tests every time. We recently upgraded Jest and brought parity to all platforms (iOS, Android and web) and then enabled our sync process. Now, every change to Jest in open source is run against all of our internal tests, and there's only a single version of Jest that's consistent everywhere.</p>
<p>The first feature we got to take advantage of after unforking was the preprocessor cache. If you are using Babel together with Jest, Jest has to pre-process every JavaScript file before it can execute it. We built a caching layer so that each file, when unchanged, only has to be transformed a single time. After we unforked Jest, we were able to easily fix up the open source implementation and shipped it at Facebook. This resulted in another 50% performance win. Because the cache only works on the second-run, the cold start time of Jest was unaffected.</p>
<p>We also realized we were doing a lot of path operations when resolving relative requires. Because the module registry is reset for every test, there were thousands of calls that could be memoized. One big optimization was to add a lot more caching, not just around a single test, but also across test files. Previously, we would generate module metadata for the automocking feature once for every test file. The object a module exports never changes however, so we now share this code across test files. Unfortunately, because JavaScript and Node.js don't have shared memory, we have to do all of this work at least once per worker process.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="question-everything">Question Everything<a href="https://danielorozco06.github.io/blog/2016/03/11/javascript-unit-testing-performance#question-everything" class="hash-link" aria-label="Direct link to Question Everything" title="Direct link to Question Everything">​</a></h2>
<p>When trying to improve performance, it's important to also dive into the systems that sit above and below your system. In the case of Jest, things like Node.js and the test files themselves, for example. One of the first things we did was to update Node.js at Facebook from the years-old 0.10 to iojs and subsequently to Node 4. The new version of V8 helped improve performance and was quite easy to upgrade to.</p>
<p>We noticed that the <code>path</code> module in Node.js is slow when making thousands of path operations which was <a href="https://github.com/nodejs/node/pull/5123" target="_blank" rel="noopener noreferrer">fixed in Node 5.7</a>. Until we drop support for Node 4 internally at Facebook, we'll ship our own version of the <a href="https://github.com/facebook/node-haste/blob/master/src/fastpath.js" target="_blank" rel="noopener noreferrer">fastpath</a> module.</p>
<p>We next started questioning the outdated <a href="https://github.com/facebook/node-haste" target="_blank" rel="noopener noreferrer">node-haste</a>. As mentioned before, the entire project has to be parsed for <code>@providesModule</code> headers to build a dependency graph. When this system was originally built, <code>node_modules</code> didn't exist and our file system crawler wasn't excluding them properly.</p>
<p>In previous versions, Jest would actually read every file in <code>node_modules</code> – which contributed to the slow startup time of Jest. When we picked up Jest again we replaced the entire project with a new implementation, based on react-native's packager. The startup time of Jest is now less than a second even on large projects. The react-native team, specifically <a href="https://twitter.com/void_0" target="_blank" rel="noopener noreferrer">David</a>, <a href="https://twitter.com/amasad" target="_blank" rel="noopener noreferrer">Amjad</a> and <a href="https://twitter.com/martinbigio" target="_blank" rel="noopener noreferrer">Martin</a> did an outstanding job on this project.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adding-everything-up">Adding everything up<a href="https://danielorozco06.github.io/blog/2016/03/11/javascript-unit-testing-performance#adding-everything-up" class="hash-link" aria-label="Direct link to Adding everything up" title="Direct link to Adding everything up">​</a></h2>
<p>A lot of the above changes improved the test runtime by 10% or sometimes even 50%. We started at a runtime of about 10 minutes for all tests, and without these improvements we'd probably be at around 20 minutes by now. After these improvements, though, it now consistently takes around 1 minute and 35 seconds to run all our tests!</p>
<p>More importantly, adding new tests causes total runtime to grow very slowly. Engineers can write and run more tests without feeling the costs.</p>
<p>With Jest's recent 0.9 release and performance improvements from the <a href="https://github.com/jestjs/jest/pull/599" target="_blank" rel="noopener noreferrer">node-haste2 integration</a>, the runtime of the <a href="https://github.com/facebook/relay" target="_blank" rel="noopener noreferrer">Relay</a> framework's test suite went down from 60 seconds to about 25 and the <a href="https://github.com/facebook/react-native" target="_blank" rel="noopener noreferrer">react-native</a> test suite now finishes in less than ten seconds on a 13” MacBook Pro.</p>
<p>We're very happy with the wins we've seen so far, and we're going to keep working on Jest and making it better. If you are curious about contributing to Jest, feel free get in touch on GitHub, <a href="https://discord.gg/j6FKKQQrW9" target="_blank" rel="noopener noreferrer">Discord</a> or Facebook :)</p>]]></content>
        <author>
            <name>Christoph Nakazawa</name>
            <uri>http://twitter.com/cpojer</uri>
        </author>
    </entry>
</feed>